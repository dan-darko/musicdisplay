<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Now Playing</title>

<!-- Preload assets so state switches feel instant -->
<link rel="preload" as="video" href="clue.mp4" />
<link rel="preload" as="image" href="flashcard.png" />

<style>
  :root{
    --text-light:#fff; --text-dark:#111;
    --safe-pad: clamp(8px, 2vmin, 22px);
    --tilt-1: -1.6deg; --tilt-2: -4.2deg; --tilt-3: 3deg;
    --art-opacity: .28;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  body{overflow:hidden}

  /* Background video */
  .bg{
    position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;filter:brightness(.9) contrast(1.02);
  }

  /* Subtle iTunes-artwork tint (hidden in non-music modes) */
  .artBGsimple{
    position:fixed;inset:0;z-index:1;pointer-events:none;opacity:var(--art-opacity);
    background-position:center;background-size:cover;background-repeat:no-repeat;
    transition:opacity 300ms ease;
  }

  /* Scrim & stage (UI layer shown only in Music mode) */
  .scrim{
    position:fixed;inset:0;z-index:2;pointer-events:none;
    background:radial-gradient(ellipse at center,rgba(0,0,0,.12) 0%,rgba(0,0,0,.55) 70%);
    transition:opacity 300ms ease;
  }
  .stage{
    position:relative;z-index:3;height:100%;width:100%;
    display:flex;flex-direction:column;align-items:center;
    padding:var(--safe-pad);gap:min(4vmin,28px);
    transition:opacity 300ms ease;
  }

  /* Logo */
  .logoWrap{
    display:grid;place-items:center;margin-top:min(2vmin,12px);
    height:36vmin;width:36vmin;max-width:320px;max-height:320px;min-width:144px;min-height:144px;overflow:visible;
  }
  .logoWrap img{width:100%;height:100%;object-fit:contain}

  .titleRow{position:relative;width:100%;display:flex;justify-content:center}

  .band{position:relative;transform-origin:center;border-radius:14px;overflow:hidden;box-shadow:0 18px 46px rgba(0,0,0,.45)}
  .band .inner{display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:clamp(10px,2.6vmin,30px) clamp(16px,3.2vmin,40px)
  }
  .band::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;mix-blend-mode:screen;
    opacity:.55;background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.05))}
  .band::after{content:"";position:absolute;top:0;left:5%;right:5%;height:40%;border-radius:inherit;filter:blur(12px);
    background:linear-gradient(180deg,rgba(255,255,255,.5),transparent);opacity:.15}

  .titleBand{
    transform:rotate(var(--tilt-1));width:min(68vw,1040px);
    background:linear-gradient(180deg,rgba(215,42,210,.85),rgba(168,20,163,.82));
    backdrop-filter:saturate(1.25) blur(8px);z-index:1
  }
  .songTitle{
    font-size:clamp(24px,7.2vmin,92px);font-weight:900;color:var(--text-light);text-align:center;
    text-shadow:0 3px 18px rgba(0,0,0,.35);max-width:92%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
  }
  .albumName{
    margin-top:clamp(6px,1.2vmin,12px);font-size:clamp(14px,3vmin,34px);font-weight:800;letter-spacing:.06em;
    color:rgba(255,255,255,.95);text-transform:uppercase;text-align:center;
    max-width:92%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
  }

  .artCard{
    position:absolute; right:min(18vmin,200px); top:50%;transform:translateY(0%) rotate(var(--tilt-3));
    width:min(21.6vw,288px);aspect-ratio:1/1;border-radius:18px;background:rgba(255,255,255,.9);
    box-shadow:0 18px 42px rgba(0,0,0,.45), inset 0 0 0 1px rgba(0,0,0,.08);
    display:grid; place-items:center; overflow:hidden;backdrop-filter:blur(4px) saturate(1.05);z-index:2;
  }
  .artCard img{
    width:100%;height:100%;object-fit:cover;display:block;border-radius:14px;
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)
  }

  .artistBand{
    transform:rotate(var(--tilt-2));width:min(52vw,760px);margin-left:min(-12vmin,-120px);margin-top:-22px;
    background:rgba(255,255,255,.92);backdrop-filter:blur(6px) saturate(1.05);z-index:3
  }
  .artistName{
    font-size:clamp(16px,4.6vmin,54px);font-weight:900;letter-spacing:.04em;color:var(--text-dark);
    text-align:center;max-width:92%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
  }

  /* Ticker */
  .ticker-wrap{
    position:fixed;left:0;right:0;bottom:0;height:8vmin;min-height:36px;z-index:4;
    display:flex;align-items:center;overflow:hidden;transition:opacity 300ms ease;
  }
  .ticker{
    white-space:nowrap;display:inline-block;animation:marq 40s linear infinite;padding-left:100%;
    font-weight:800;letter-spacing:.06em;font-size:clamp(12px,2.4vmin,20px);text-transform:uppercase
  }
  @keyframes marq{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

  /* Bottom-left stealth hotspot */
  .stealthHotspot{
    position:fixed;left:2.2vmin;bottom:2.2vmin;z-index:5;width:9vmin;height:9vmin;min-width:40px;min-height:40px;
    background:transparent;border:none;outline:none;border-radius:999px;
    opacity:0; /* keep invisible to guests */
  }
  .stealthHotspot:focus{outline:2px dashed rgba(255,255,255,.25);outline-offset:4px}

  /* FLASHCARD overlay (only in Card mode) */
  .flashcard{
    position:fixed;inset:0;z-index:3;display:grid;place-items:center;pointer-events:none;
    opacity:0;transition:opacity 300ms ease;
  }
  .flashcard img{
    max-width:min(86vw,1400px);max-height:min(86vh,1400px);width:auto;height:auto;
    filter:drop-shadow(0 30px 80px rgba(0,0,0,.6));
  }

  /* MODE STATES
     - mode-music: full UI
     - mode-card : bg.mp4 + centered flashcard
     - mode-clue : clue.mp4 only
  */
  body.mode-music { --art-opacity: .28; }
  body.mode-card  { --art-opacity: 0; }
  body.mode-clue  { --art-opacity: 0; }

  body.mode-card .stage,
  body.mode-card .ticker-wrap,
  body.mode-card .scrim,
  body.mode-clue .stage,
  body.mode-clue .ticker-wrap,
  body.mode-clue .scrim{
    opacity:0; pointer-events:none;
  }

  body.mode-card .flashcard{ opacity:1; }

  /* No-glass fallback */
  .no-glass .titleBand,.no-glass .artistBand{backdrop-filter:none}
</style>
</head>
<body class="mode-music">
  <!-- Background video -->
  <video id="bg" class="bg" autoplay muted loop playsinline webkit-playsinline preload="auto">
    <source id="bgsrc" src="bg.mp4" type="video/mp4" />
  </video>

  <!-- Artwork tint -->
  <div id="artBGsimple" class="artBGsimple"></div>

  <div class="scrim"></div>

  <!-- FLASHCARD (rules/info) -->
  <div class="flashcard" aria-hidden="true">
    <img src="flashcard.png" alt="" />
  </div>

  <!-- Main UI -->
  <div class="stage">
    <div class="logoWrap">
      <img src="logo.png" alt="Event Logo" loading="eager" />
    </div>

    <div class="titleRow">
      <div class="band titleBand" id="titleBand">
        <div class="inner">
          <div id="title" class="songTitle">TITLE</div>
          <div id="album" class="albumName">ALBUM</div>
        </div>
      </div>

      <div class="artCard" id="artCard" aria-hidden="true">
        <img id="artwork" src="" alt="" />
      </div>
    </div>

    <div class="band artistBand" id="artistBand">
      <div class="inner">
        <span id="artist" class="artistName">ARTIST</span>
      </div>
    </div>

    <div id="state" class="paused"></div>
  </div>

  <!-- Ticker -->
  <div class="ticker-wrap">
    <div class="ticker">
      <span>Welcome to The Mayplace Curse! • GAME RULES: When the TV timer begins, you have one hour to return the cursed doll. Work as a team, be respectful of the house, only open what seems relevant to a clue, and put things back nicely. Please don’t move heavy furniture or force anything. Have fun & good luck! •</span>
    </div>
  </div>

  <!-- Invisible bottom-left hotspot -->
  <button id="stealthToggle" class="stealthHotspot" title="Next screen" tabindex="0" aria-label="Next screen"></button>

  <script type="module">
    /* -------- Feature flags / fallbacks -------- */
    const qp = new URL(location.href).searchParams;
    const forceLite = qp.get('mode') === 'lite';
    const supportsGlass = CSS.supports('backdrop-filter','blur(2px)');
    if (forceLite || !supportsGlass) document.documentElement.classList.add('no-glass');

    /* -------- Firebase (track info) -------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRUgh9Z7CezSj1hDbfEKhocwqEtIohQPQ",
      authDomain: "music-display-1d354.firebaseapp.com",
      databaseURL: "https://music-display-1d354-default-rtdb.firebaseio.com",
      projectId: "music-display-1d354",
      storageBucket: "music-display-1d354.appspot.com",
      messagingSenderId: "555717940924",
      appId: "1:555717940924:web:7d5f9d3c8f7d6f9f8b3d2f"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const el = {
      title: document.getElementById('title'),
      artist: document.getElementById('artist'),
      album: document.getElementById('album'),
      art: document.getElementById('artwork'),
      artBG: document.getElementById('artBGsimple'),
      state: document.getElementById('state'),
    };

    function safeText(n, fallback="") {
      return (n ?? "").toString().replace(/\s+/g,' ').trim() || fallback;
    }

    function setArtwork(url){
      if(!url){ el.art.removeAttribute('src'); el.artBG.style.backgroundImage='none'; return; }
      el.art.src = url;
      el.artBG.style.backgroundImage = `url("${url}")`;
    }

    // Listen for track updates (same RTDB path you used before)
    onValue(ref(db, 'nowPlaying'), (snap)=>{
      const v = snap.val() || {};
      el.title.textContent  = safeText(v.title, 'TITLE');
      el.artist.textContent = safeText(v.artist, 'ARTIST');
      el.album.textContent  = safeText(v.album, 'ALBUM');
      setArtwork(v.artwork || "");
      el.state.className = v.state || 'paused';
    });

    /* -------- Video control + Mode state machine -------- */
    const DEFAULT_VIDEO = 'bg.mp4';
    const CLUE_VIDEO = 'clue.mp4';
    const vid    = document.getElementById('bg');
    const vidSrc = document.getElementById('bgsrc');

    function playVideo() {
      try {
        vid.muted = true;
        const p = vid.play();
        if (p && p.catch) p.catch(()=>{});
      } catch(_) {}
    }

    function swapVideo(src){
      const current = vidSrc.getAttribute('src');
      if (current === src) { playVideo(); return; }
      vidSrc.setAttribute('src', src);
      try { vid.load(); } catch(_) {}
      vid.currentTime = 0;
      playVideo();
    }

    // Keep video alive across TVs
    vid.addEventListener('ended', ()=>{ try{ vid.currentTime = 0; playVideo(); }catch(e){} });
    setInterval(()=>{ if (vid.paused || vid.readyState < 2) playVideo(); }, 8000);

    // Modes: music -> card -> clue -> music
    const MODES = ['mode-music','mode-card','mode-clue'];
    let modeIndex = 0;

    function applyMode(){
      document.body.classList.remove(...MODES);
      document.body.classList.add(MODES[modeIndex]);

      if (MODES[modeIndex] === 'mode-music') {
        swapVideo(DEFAULT_VIDEO);
      } else if (MODES[modeIndex] === 'mode-card') {
        swapVideo(DEFAULT_VIDEO); // keep bg.mp4 while showing flashcard
      } else {
        swapVideo(CLUE_VIDEO);    // clue mode
      }
    }

    function nextMode(){
      modeIndex = (modeIndex + 1) % MODES.length;
      applyMode();
    }

    // Stealth button wiring
    (function(){
      const btn = document.getElementById('stealthToggle');
      btn.addEventListener('click', nextMode);
      btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); nextMode(); });
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); nextMode(); }
      });
      try { btn.focus({preventScroll:true}); } catch(_) {}
    })();

    // Start in Music mode explicitly
    applyMode();
  </script>
</body>
</html>
